# Handoff - 2026-02-17

## Session Summary

This session moved `mtUp` from local-only behavior to a working Supabase-backed dev baseline with multi-group-aware schema and passing automated tests. Auth was stabilized via REST token flow, proposals + availabilities were migrated to Supabase mode, and critical e2e coverage was added.

## Completed Work

### 1) Supabase Foundations + Group-Aware Schema

- Added Supabase migration assets:
  - `docs/supabase/001_initial_group_aware_schema.sql`
  - `docs/supabase/002_seed_example_profiles_and_group.sql`
  - `docs/supabase/003_seed_second_group_isolation.sql`
  - `docs/supabase/004_rls_isolation_verification.sql`
  - `docs/supabase/005_rls_hotfix_group_memberships_recursion.sql`
- Added architecture and migration scaffolding docs:
  - `docs/current-architecture-truth.md`
  - `.env.example`
  - `docs/supabase/README.md`

### 2) Runtime Mode + Supabase Client

- Added runtime data-source switch:
  - `src/lib/runtimeConfig.ts`
- Added Supabase client module and token helpers:
  - `src/lib/supabase.ts`
- Startup now logs active data source:
  - `src/main.tsx`

### 3) Auth Migration (Stabilized)

- Migrated auth context for Supabase mode:
  - `src/lib/AuthContext.tsx`
- Implemented profile bootstrap (`profiles` upsert when missing).
- Replaced hanging SDK session path with reliable REST token flow + local token persistence:
  - login uses `/auth/v1/token?grant_type=password`
  - session bootstrap uses `/auth/v1/user`
- Updated login UI for Supabase mode:
  - email label/placeholder
  - async submit handling and timeout-safe UX
  - password autocomplete attribute
  - `src/components/Login.tsx`

### 4) Proposals + Availabilities Migrated to Supabase Mode

- ProposalContext now loads:
  - memberships/groups
  - group-scoped proposals
  - group-scoped availabilities
- Proposal CRUD now writes to Supabase in supabase mode.
- Availability CRUD now writes to Supabase in supabase mode.
- Added optimistic availability updates to eliminate add/remove race.
- Added empty-dates delete behavior for availabilities.
- Added group fallback on proposal create when `activeGroupId` has not resolved yet.
- Key file:
  - `src/lib/ProposalContext.tsx`

### 5) RLS Recursion Production Hotfix

- Fixed `group_memberships` policy recursion causing `54001 stack depth limit exceeded`.
- Updated base schema policy and added explicit hotfix SQL.

### 6) Testing Baseline Added and Running

- Vitest configured:
  - `vitest.config.ts`
  - `src/lib/runtimeConfig.test.ts`
  - `src/lib/supabase.test.ts`
- Playwright configured:
  - `playwright.config.ts`
  - `tests/e2e/auth-smoke.spec.ts`
  - `tests/e2e/app-flows.spec.ts`
- Current Playwright suite covers:
  - login/dashboard access
  - proposal create + reload persistence
  - admin delete-all dialog trigger
  - availability persistence
  - ctrl/cmd remove availability persistence
  - month-lane click opens Activity Details modal
  - cross-user visibility expectation

## Verification

- `npm run build`: passing
- `npm run test:run` (Vitest): passing
- `npm run test:e2e` (Playwright): passing (`8/8`)

## Current State (Important)

- Supabase auth is active in dev mode and functional.
- In supabase mode:
  - proposals: Supabase-backed
  - availabilities: Supabase-backed
  - decisions (`decision_configs/options/votes/confirmations`): still local-backed (next migration slice)
- Multi-group model exists in schema and is partially exercised.

## Known Risks / Notes

1. Auth currently uses a REST token path and local token storage workaround due SDK session hangs in this environment.
2. Decision entities are still split between local and Supabase paths.
3. Group selector UX is not yet exposed in UI; active group resolves from memberships.

## Recommended Next Steps

1. Migrate decision entities to Supabase (`decision_configs/options/votes/confirmations`).
2. Add group selector UI (current user memberships -> switch active group).
3. Add RLS-focused integration checks for cross-group decision visibility.
4. Once data migration is complete, remove local fallback from ProposalContext/Auth paths.
